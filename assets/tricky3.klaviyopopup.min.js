!function(e){var o=function(o,i){var a={CookieName:"KlaviyoPopup",SessionCookieName:"KlaviyoPopupSession",Visits:[],Delay:1e4,PageViewNumber:1,CloseSelectors:[],ShowSelectors:[],ShowPopupOnCurrentPage:!1,InnerWrapper:".modal",SignupKey:"signup",HidePopupOnSuccess:!0,HidePopupOnSuccessTimeout:5e3,ShowAlertMessage:!0,AjaxSubmitAttr:"data-ajax-submit",BValidatorOptions:{singleError:!0},CallBacks:{OnSuccess:function(){},OnError:function(){},OnDisplayed:function(){},OnClosed:function(){},OnFormSubmitted:function(){},BeforeSubmit:function(){}},MessageWrapperSelectors:{Success:".klaviyo_messages .success_message",Error:".klaviyo_messages .error_message"},Messages:{Success:"Thank you!"}};e.extend(a,i||{});var s={VisitsCookieTracker:{Status:"",PageView:0,Visits:0,PopupAlreadyShownOnVisit:[]},CookiesValues:{NotSubmitted:"NotSubmitted",HasSubmitted:"HasSubmitted",ShowOnNextVisit:"ShowOnNextVisit",ErrorInSubmitted:"ErrorInSubmitted"},MainWrapper:o,KForm:e("form",this.MainWrapper)},t={Initialize:function(){this.Hide(!1),this.ReadAndSetupCookieValues(),this.InitCustomEvents()},InitDefaultKlaviyoCookies:function(){var e="klaPages",o=parseInt(T3Core.CookieManager.ReadCookie(e),10);o=isNaN(o)?1:o+1,T3Core.CookieManager.CreateCookie(e,o,365)},InitCustomEvents:function(){for(var o=0;o<a.CloseSelectors.length;o++){var i=e(a.CloseSelectors[o]);i.click(function(e){return t.Hide(!0),e.stopPropagation(),!1})}for(var o=0;o<a.ShowSelectors.length;o++){var i=e(a.ShowSelectors[o]);i.click(function(e){return t.Show(!0),e.stopPropagation(),!1})}e(document).keydown(function(e){keycode=null==e?event.keyCode:e.which,27==keycode&&t.Hide(!0)}),s.MainWrapper.click(function(){e(this).hasClass("modalize")&&t.Hide(!0)}),e(a.InnerWrapper,s.MainWrapper).click(function(e){e.stopPropagation()})},Hide:function(e){s.MainWrapper.removeClass("modalize"),t.CallBackHandler.OnClosed(e)},ReadAndSetupCookieValues:function(){var e=T3Core.CookieManager.ReadCookie(a.SessionCookieName),o=this.ReadJsonFromCookie(a.CookieName);if(null==o&&null==e)T3Core.CookieManager.CreateCookie(a.SessionCookieName,1),this.SaveJsonToCookie(a.CookieName,s.CookiesValues.ShowOnNextVisit,1,1,"",30),o=this.ReadJsonFromCookie(a.CookieName);else if(null==o&&(this.SaveJsonToCookie(a.CookieName,s.CookiesValues.ShowOnNextVisit,1,1,"",30),o=this.ReadJsonFromCookie(a.CookieName)),null==e){var i=o,n=i.Visits+1,r=i.PageView;T3Core.CookieManager.CreateCookie(a.SessionCookieName,n),i.Status==s.CookiesValues.ShowOnNextVisit&&this.SaveJsonToCookie(a.CookieName,s.CookiesValues.ShowOnNextVisit,r,n,"",30)}o.Status==s.CookiesValues.ShowOnNextVisit&&a.ShowPopupOnCurrentPage&&t.ProcessCookiesValuesAndShowPopupIfNeeded()},ReadJsonFromCookie:function(e){var o=T3Core.CookieManager.ReadCookie(e),i=null;if(null!=o)try{i=JSON.parse(o)}catch(a){-1!=o.indexOf(s.CookiesValues.HasSubmitted)&&(t.SaveJsonToCookie(e,s.CookiesValues.HasSubmitted,"","","",365),i=JSON.parse(T3Core.CookieManager.ReadCookie(e)))}return i},ProcessCookiesValuesAndShowPopupIfNeeded:function(){var o=this.ReadJsonFromCookie(a.CookieName),i={PageView:0,Visits:0,NeedToShowPopupOnCurrentVisit:!1,NeedToShowPopupOnCurrentPageView:!1,PopupAlreadyShown:!1,ShowPopup:!1};if(i.PageView=parseInt(o.PageView),i.Visits=parseInt(o.Visits),o.PopupAlreadyShownOnVisit.length>0&&(i.PopupAlreadyShown=-1!=e.inArray(i.Visits,o.PopupAlreadyShownOnVisit)),i.NeedToShowPopupOnCurrentVisit=-1!=e.inArray(i.Visits,a.Visits)&&!i.PopupAlreadyShown,i.NeedToShowPopupOnCurrentPageView=i.PageView==a.PageViewNumber,i.NeedToShowPopupOnCurrentVisit&&i.PageView<=a.PageViewNumber)if(i.NeedToShowPopupOnCurrentPageView)this.SaveJsonToCookie(a.CookieName,s.CookiesValues.ShowOnNextVisit,1,i.Visits,i.Visits,30);else{var t=i.PageView+1;this.SaveJsonToCookie(a.CookieName,s.CookiesValues.ShowOnNextVisit,t,i.Visits,"",30)}i.Visits>a.Visits[a.Visits.length-1],i.ShowPopup=i.NeedToShowPopupOnCurrentVisit&&i.NeedToShowPopupOnCurrentPageView,i.ShowPopup&&this.Show(!1)},Show:function(e){var o=e?1e3:a.Delay;setTimeout(function(){s.MainWrapper.addClass("modalize"),t.CallBackHandler.OnDisplayed(),t.InitBValidator(),t.InitAjaxSubmit()},o)},InitBValidator:function(){s.KForm.bValidator(a.BValidatorOptions)},InitAjaxSubmit:function(){s.KForm.submit(function(o){var i=e(this);if(i.data("bValidator").isValid()){t.CallBackHandler.BeforeSubmit();var s=i.attr(a.AjaxSubmitAttr),n=(new Date).getTimezoneOffset()/-60;e(".timeOffset",i).length?e(".timeOffset",i).val(n):i.append('<input type="hidden" value="'+n+'" class="timeOffset klaviyo-field" name="$timezone_offset"/>');var r=decodeURIComponent(i.find(".klaviyo-field").serialize()),u=e(this).find(".klaviyo-custom-property").map(function(){return e(this).attr("name")}).get();return u.length&&(r+="&$fields="+u.join(",")),e.post(s,r,t.AjaxFormSubmitCallBack),t.CallBackHandler.OnFormSubmitted(),o.stopPropagation(),!1}})},AjaxFormSubmitCallBack:function(o){if(o.success){t.UserHasSignedUp=!0,t.SaveJsonToCookie(a.CookieName,s.CookiesValues.HasSubmitted,"","","",365);var i=e(a.MessageWrapperSelectors.Success,s.MainWrapper);i.append(a.Messages.Success).css("display","block"),t.CallBackHandler.OnSuccess(o),a.HidePopupOnSuccess&&setTimeout(function(){t.Hide(!1)},a.HidePopupOnSuccessTimeout)}else{var n=e(a.MessageWrapperSelectors.Error,s.MainWrapper);e(o.errors).each(function(){n.append("<p>"+this+"</p>")}),n.css("display","block"),t.CallBackHandler.OnError(o)}},SaveJsonToCookie:function(e,o,i,a,t,n){s.VisitsCookieTracker.Status=o,s.VisitsCookieTracker.PageView=i,s.VisitsCookieTracker.Visits=a,""!=t&&s.VisitsCookieTracker.PopupAlreadyShownOnVisit.push(t),T3Core.CookieManager.CreateCookie(e,JSON.stringify(s.VisitsCookieTracker),n)},UserHasSignedUp:!1};t.CallBackHandler={OnClosed:function(e){a.CallBacks.OnClosed&&a.CallBacks.OnClosed(e&&!t.UserHasSignedUp)},OnFormSubmitted:function(){a.CallBacks.OnFormSubmitted&&a.CallBacks.OnFormSubmitted()},OnDisplayed:function(){a.CallBacks.OnDisplayed&&a.CallBacks.OnDisplayed()},OnError:function(e){a.CallBacks.OnError&&a.CallBacks.OnError(e)},OnSuccess:function(e){a.CallBacks.OnSuccess&&a.CallBacks.OnSuccess(e,s.MainWrapper)},BeforeSubmit:function(){a.CallBacks.BeforeSubmit&&a.CallBacks.BeforeSubmit()}},function(){var e=T3Core.GetQueryStringByKey(a.SignupKey);""!=e?1==e&&(t.Initialize(),t.Show()):t.Initialize(),t.InitDefaultKlaviyoCookies()}()};e.fn.KlaviyoPopup=function(e){return new o(this,e)}}(jQuery);